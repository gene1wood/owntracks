<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="OwnTracks.org" /><link rel="canonical" href="http://owntracks.org/tech/lua/" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>Lua - OwnTracks Booklet</title>

  <link rel="stylesheet" href="../../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../css/theme_extra.css" type="text/css" />
  <link href="../../extra.css" rel="stylesheet">
    
      <script>
        // Current page data
        var mkdocs_page_name = "Lua";
        var mkdocs_page_input_path = "tech/lua.md";
        var mkdocs_page_url = "/tech/lua/";
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]--> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> OwnTracks Booklet
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../..">Intro</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Guide</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../guide/whathow/">What it does</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../guide/quicksetup/">Quicksetup</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../guide/apps/">Apps</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Features</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../features/comparison/">Comparison</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../features/security/">Security</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../features/location/">Location</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">API</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../json/">JSON</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../http/">HTTP</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../program/">Code</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Sundry</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../privacy/">Privacy</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../people/">People</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../faq/">Answers</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../press/">Press</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">OwnTracks Booklet</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">Lua</li>
    <li class="wy-breadcrumbs-aside">
          <a href="https://github.com/owntracks/booklet/edit/master/docs/tech/lua.md" class="icon icon-github"> Edit on GitHub</a>
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h2 id="lua-hooks">Lua hooks<a class="headerlink" href="#lua-hooks" title="Permanent link">#</a></h2>
<p>If Recorder is compiled with Lua support (which we do by default), a Lua script you provide is launched at startup. Lua is <em>a powerful, fast, lightweight, embeddable scripting language</em>. You can use this to process location publishes in any way you desire: your imagination (and Lua-scripting knowhow) set the limits. Some examples:</p>
<ul>
<li>insert received publishes into a database of your choice</li>
<li>switch on the coffee machine when your OwnTracks device reports you're entering home (but see also <a href="http://jpmens.net/2014/02/17/introducing-mqttwarn-a-pluggable-mqtt-notifier/">mqttwarn</a>)</li>
<li>write a file with data in a format of your choice (see <a href="https://github.com/owntracks/recorder/blob/master/etc/example.lua">etc/example.lua</a>)</li>
</ul>
<p>Run the Recorder with the path to your Lua script specified in its <code>--lua-script</code> option (there is no default). If the script cannot be loaded (e.g. because it cannot be read or contains syntax errors), the Recorder aborts with a diagnostic.</p>
<p>Configure <code>lua_script:</code> in our <a href="../../guide/quicksetup/">quicksetup</a> <code>configuration.yaml</code> to have this enabled for you.</p>
<p>If the Lua script can be loaded, it is automatically provided with a table variable called <code>otr</code> which contains the following members:</p>
<ul>
<li><code>otr.version</code> is a read-only string with the Recorder version (example: <code>"0.3.2"</code>)</li>
<li><code>otr.log(s)</code> is a function which takes a string <code>s</code> which is logged to syslog at the Recorder's facility and log level INFO.</li>
<li><code>otr.strftime(fmt, t)</code> is a function which takes a format string <code>fmt</code> (see <code>strftime(3)</code>) and an integer number of seconds <code>t</code> and returns a string with the formatted UTC time. If <code>t</code> is 0 or negative, the current system time is used.</li>
</ul>
<p>Your Lua script <em>must</em> provide the following functions:</p>
<h2 id="otr_init"><code>otr_init</code><a class="headerlink" href="#otr_init" title="Permanent link">#</a></h2>
<p>This is invoked at start of Recorder. If the function returns a non-zero value, Recorder unloads Lua and disables its processing; i.e. the <code>hook()</code> will <em>not</em> be invoked on location publishes.</p>
<h2 id="otr_exit"><code>otr_exit</code><a class="headerlink" href="#otr_exit" title="Permanent link">#</a></h2>
<p>This is invoked when the Recorder stops, which it doesn't really do unless you CTRL-C it or send it a SIGTERM signal.</p>
<h2 id="otr_hook"><code>otr_hook</code><a class="headerlink" href="#otr_hook" title="Permanent link">#</a></h2>
<p>This function is invoked at every location publish processed by the Recorder. Your function is passed three arguments:</p>
<ol>
<li><em>topic</em> is the topic published to (e.g. <code>owntracks/jane/phone</code>)</li>
<li><em>type</em> is the type of MQTT message. This is the <code>_type</code> in our JSON messages (e.g. <code>location</code>, <code>cmd</code>, <code>transition</code>, ...) or <code>"unknown"</code>.</li>
<li><em>location</em> is a <a href="http://www.lua.org/pil/2.5.html">Lua table</a> (associative array) with all the elements obtained in the JSON message. In the case of <em>type</em> being <code>location</code>, we also add country code (<code>cc</code>) and the location's address (<code>addr</code>) unless reverse-geo lookups have been disabled in Recorder.</li>
</ol>
<p>Assume the following small example Lua script in <code>example.lua</code>:</p>
<pre><code>    local file

    function otr_init()
        otr.log("example.lua starting; writing to /tmp/lua.out")
        file = io.open("/tmp/lua.out", "a")
        file:write("written by OwnTracks Recorder version " .. otr.version .. "\n")
    end

    function otr_hook(topic, _type, data)
        local timestr = otr.strftime("It is %T in the year %Y", 0)
        print("L: " .. topic .. " -&gt; " .. _type)
        file:write(timestr .. " " .. topic .. " lat=" .. data['lat'] .. data['addr'] .. "\n")
    end

    function otr_exit()
    end
</code></pre>
<p>When Recorder is launched with <code>--lua-script example.lua</code> it invokes <code>otr_init()</code> which opens a file. Then, for each location received, it calls <code>otr_hook()</code> which updates the file.</p>
<p>Assuming an OwnTracks device publishes this (shortened for clarity) payload</p>
<pre><code>    {"batt":-1,"lon":2.29513,"lat":48.85833,"t":"u","tst":1441984413,"_type":"location","tid":"JJ"}
</code></pre>
<p>the file <code>/tmp/lua.out</code> would contain</p>
<pre><code>    written by OwnTracks Recorder version 0.3.0
    It is 17:13:33 in the year 2015 owntracks/jane/phone lat=48.858339 Avenue Anatole France, 75007 Paris, France
</code></pre>
<h2 id="republishing-http-posts">Republishing HTTP posts<a class="headerlink" href="#republishing-http-posts" title="Permanent link">#</a></h2>
<p>OwnTracks location (and other type) publishes submitted via HTTP are not automatically republished to MQTT. Should you wish to do this, Lua hooks can help accomplish this. The following example illustrates how to do so.</p>
<pre><code>  -- requires: 
  --   a) Compile recorder with -DLUA and configure
  --   b) OTR_LUASCRIPT = ".../repub.lua"
  -- also requires Lua JSON from http://regex.info/blog/lua/json

  JSON = (loadfile "/etc/ot-recorder/JSON.lua")()

  function otr_init()
  end

  function otr_exit()
  end

  function otr_hook(topic, _type, data)
      otr.log("DEBUG_PUB:" .. topic .. " " .. JSON:encode(data))
      if(data['_http'] == true) then
          if(data['_repub'] == true) then
             return
          end
          data['_repub'] = true
          local payload = JSON:encode(data)
          otr.publish(topic, payload, 1, 1)
      end
  end
</code></pre>
<p>There's <a href="https://github.com/owntracks/recorder/blob/master/doc/HOOKS.md">more information on this</a> with examples, including creating a per-JSON-element hook, if you're interested.</p>
              
            </div>
          </div><footer>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/owntracks/booklet" class="fa fa-github" style="color: #fcfcfc"> GitHub</a>
        </span>
    
    
    
  </span>
</div>
    <script src="../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../..";</script>
    <script src="../../js/theme_extra.js"></script>
    <script src="../../js/theme.js"></script>
      <script src="../../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
