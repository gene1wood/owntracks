<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <meta name="author" content="OwnTracks.org">
  <link rel="canonical" href="http://owntracks.org/tech/http/">
  <link rel="shortcut icon" href="../../img/favicon.ico">
  <title>HTTP - OwnTracks Booklet</title>

  <link rel="stylesheet" href="../../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../css/theme_extra.css" type="text/css" />
  
  <script>
    // Current page data
    var mkdocs_page_name = "HTTP";
    var mkdocs_page_input_path = "tech/http.md";
    var mkdocs_page_url = "/tech/http/";
  </script>
  
  <script src="../../js/jquery-2.1.1.min.js" defer></script>
  <script src="../../js/modernizr-2.8.3.min.js" defer></script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
        <a href="../.." class="icon icon-home"> OwnTracks Booklet</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../..">Intro</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Guide</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../guide/whathow/">What it does</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../guide/clients/">Clients</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../guide/scenarios/">Scenarios</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../guide/apps/">Apps</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../guide/topics/">Topics</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../guide/broker/">Broker</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../guide/bridge/">Bridging</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../guide/waypoints/">Waypoints</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../guide/beacons/">Beacons</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Features</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../features/comparison/">Comparison</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../features/ios/">iOS</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../features/android/">Android</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../features/security/">Security</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../features/tls/">TLS</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../features/tlscert/">TLS client</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../features/location/">Location</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../features/tid/">Tracker ID</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../features/friends/">Friends</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../features/card/">Card</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../features/waypoints/">Waypoints</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../features/beacons/">Beacons</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../features/pedometer/">Pedometer</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../features/featured/">Featured</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../features/encrypt/">Encryption</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../features/remoteconfig/">Remoteconfig</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../features/debug/">Debugging</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../features/traccar/">Traccar</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">API</span></p>
                <ul class="current">
                    <li class="toctree-l1"><a class="reference internal" href="../json/">JSON</a>
                    </li>
                    <li class="toctree-l1 current"><a class="reference internal current" href="./">HTTP</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#distinguishing-payloads">Distinguishing payloads</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#php-example">PHP example</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#testing-your-http-endpoint">Testing your HTTP endpoint</a>
    </li>
    </ul>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../mqtt/">MQTT</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../qr/">URIs and QR codes</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../program/">Code</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Sundry</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../terminology/">Terminology</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../clients/recorder/">Docker</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../privacy/">Privacy</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../people/">People</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../ideas/">Ideas</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../faq/">Answers</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../press/">Press</a>
                    </li>
                </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../..">OwnTracks Booklet</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../..">Docs</a> &raquo;</li>
    
      
        
          <li>API &raquo;</li>
        
      
    
    <li>HTTP</li>
    <li class="wy-breadcrumbs-aside">
      
        <a href="https://github.com/owntracks/booklet/edit/master/docs/tech/http.md"
          class="icon icon-github"> Edit on GitHub</a>
      
    </li>
  </ul>
  
  <hr/>
</div>

          <div role="main">
            <div class="section">
              
                <h2 id="http">HTTP</h2>
<p>An optional HTTP mode is implemented with which the OwnTracks apps use a privately configured HTTP endpoint (a.k.a. a Web server) to which they POST requests over HTTP instead of publishing to MQTT. In this mode all <a href="../json/">JSON</a> payloads reported by the apps are transmitted via HTTP to the endpoint. In particular and most importantly, the apps publish their location data. Note that the length of the payload may be zero if a friend is deleted from the app: the zero-length message which is normally published via MQTT will be POSTed via HTTP to your endpoint; as such it is best to ignore zero-length payloads.</p>
<p>The URL you enter in the setting for HTTP mode has the following syntax:</p>
<pre><code>http[s]://[user[:password]@]host[:port]/path
</code></pre>
<p>Authentication to the endpoint is performed with HTTP Basic authentication and, as such, we very strongly recommend the use of TLS (<code>https://</code> scheme). The <a href="../../features/encrypt/">encryption</a> feature is supported, and you can use it with HTTP endpoints; the Owntracks Recorder supports decryption, but if you implement your own endpoint you have to perform decryption at the endpoint yourself.</p>
<p>The Recorder supports <a href="https://github.com/owntracks/recorder#http-mode">HTTP mode</a> out of the box at the <code>/pub</code> end point, as long as it is built with HTTP support and a <code>--http-port</code> is configured. When using Recorder in this mode, set the URL to:</p>
<pre><code>http[s]://recorder_host[:port]/pub
</code></pre>
<p>The username and password for HTTP Basic authentication can be configured in application settings, under <em>Identification</em>. Device name and tracker name can also be configured there. Username and device name are <em>required</em> when using the Recorder. Parameters for <em>username</em> and <em>devicename</em> can also be included in the URL (<code>?u=user&amp;d=device</code>), or alternatively using the <code>X-Limit-U</code> and <code>X-Limit-D</code> headers respectively. You can also force <em>username</em> using a proxy as described in the Recorder's documentation.</p>
<p>All publishes which are currently done with MQTT will then be POSTed to the endpoint with exactly the same <a href="../json/">JSON</a> payload formats. Support for Friends is available if your HTTP endpoint can produce appropriate data which is consumed by the app whenever it POSTs a location. This differs greatly from MQTT mode wherein the app subscribes to topics and is informed of data on those topics whenever it's available; in HTTP mode the apps do not periodically poll your HTTP endpoint; rather it is contacted only when the app is ready to publish its location or when you manually trigger a publish. (Support for friends and optionally their cards is implemented in the Recorder.)</p>
<p>If the HTTP endpoint is reachable (no exception, no timeout, DNS name exists, etc.) and a successfull return code (<code>2xx</code>) is returned  the payload is considered POSTed. In the event that the endpoint is unreachable, the payload will be queued and posted at a later time.</p>
<p>If the HTTP endpoint returns a status code 200 it will typically return an empty JSON payload array <code>[]</code>. It may, however, return an array of JSON objects to the OwnTracks device, each of which must be a valid <code>_type</code> as described in <a href="../json/">JSON</a>. Support for the following <code>_type</code> is implemented:</p>
<table>
<thead>
<tr>
<th align="left"><code>_type</code></th>
<th align="left">iOS</th>
<th align="left">Android</th>
<th align="left">Usage</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left"><code>location</code></td>
<td align="left">Y</td>
<td align="left">Y</td>
<td align="left">Can return friend location objects.</td>
</tr>
<tr>
<td align="left"><code>cmd</code></td>
<td align="left">Y</td>
<td align="left">Y</td>
<td align="left">with <code>action</code> set to <code>dump</code>, <code>reportLocation</code>, <code>reportSteps</code>, <code>action</code>, and <code>setWaypoints</code></td>
</tr>
<tr>
<td align="left"><code>card</code></td>
<td align="left">Y</td>
<td align="left">Y</td>
<td align="left">Can return <a href="../../features/card/">card</a> objects for self and friends</td>
</tr>
<tr>
<td align="left"><code>transition</code></td>
<td align="left">Y</td>
<td align="left">Y</td>
<td align="left">Obtain friends' transition events.</td>
</tr>
</tbody>
</table>
<h3 id="distinguishing-payloads">Distinguishing payloads</h3>
<p>When a message is received over MQTT, the payload is sent to a topic, and this topic can be used to map the message to the user and their device. In the case that a message is received over HTTP, we don't have the context of a topic; instead, the iOS and Android apps use a different approach to help you figure out where the message came from:</p>
<ul>
<li>On iOS, a new <code>topic</code> key is added to the payload if the payload is unencrypted. If the payload is encrypted, the <code>topic</code> key is only available in the decrypted payload.</li>
<li>Both the Android and iOS apps (iOS after <a href="https://github.com/owntracks/ios/issues/560">#560</a> is implemented) include headers to identify the user (<code>X-Limit-U</code>) and the device (<code>X-Limit-D</code>) if the user has entered this information in the "Identification" section of the connection settings.</li>
</ul>
<pre><code>Content-Type: application/json
X-Limit-U: jjolie
X-Limit-D: myphone
</code></pre>
<h3 id="php-example">PHP example</h3>
<p>Using a simple PHP script which you host, say, on an Apache or nginx server, you can quite easily record locations POSTed from the OwnTracks apps. The following very simple example will fill a database table:</p>
<pre><code>mysql&gt; select * from locations;
+---------------------+------+-----------+----------+
| dt                  | tid  | lat       | lon      |
+---------------------+------+-----------+----------+
| 2016-02-20 09:16:05 | JJ   | 48.858330 | 2.295130 |
| 2016-02-20 09:19:49 | JJ   | 48.860430 | 2.294010 |
+---------------------+------+-----------+----------+
</code></pre>
<p>For the sake of clarity this example uses a database table with a MySQL timestamp column which is automatically set upon INSERT; keep in mind that the real location event posted by the OwnTracks apps has a <code>tst</code> timestamp when the event actually occurred.</p>
<pre><code class="language-php">&lt;?php
    # Obtain the JSON payload from an OwnTracks app POSTed via HTTP
    # and insert into database table.

    header(&quot;Content-type: application/json&quot;);

    $payload = file_get_contents(&quot;php://input&quot;);
    $data =  @json_decode($payload, true);

    if ($data['_type'] == 'location') {

        # CREATE TABLE locations (dt TIMESTAMP, tid CHAR(2), lat DECIMAL(9,6), lon DECIMAL(9,6));
        $mysqli = new mysqli(&quot;127.0.0.1&quot;, &quot;user&quot;, &quot;password&quot;, &quot;database&quot;);

        $tst = $data['tst'];
        $lat = $data['lat'];
        $lon = $data['lon'];
        $tid = $data['tid'];

        # Convert timestamp to a format suitable for mysql
        $dt = date('Y-m-d H:i:s', $tst);

        $sql = &quot;INSERT INTO locations (dt, tid, lat, lon) VALUES (?, ?, ?, ?)&quot;;
        $stmt = $mysqli-&gt;prepare($sql);
        # bind parameters (s = string, i = integer, d = double,  b = blob)
        $stmt-&gt;bind_param('ssdd', $dt, $tid, $lat, $lon);
        $stmt-&gt;execute();
        $stmt-&gt;close();
    }

    $response = array();
    # optionally add objects to return to the app (e.g.
    # friends or cards)
    print json_encode($response);
?&gt;
</code></pre>
<p>Assuming the Web server hosting this example is called <code>example.com</code>, and assuming the above script is in Jane's home directory's <code>public_html</code> saved as <code>loc.php</code>, the URL you configure in the OwnTracks app would be <code>http://example.com/~jane/loc.php</code>. We <em>urge</em> you to consider transmitting your data to your Web server securely using TLS and authentication, in which case the URL you use will be along the lines of <code>https://user:password@example.com/~jane/loc.php</code>.</p>
<p>There's lots of other data in the JSON payload from the OwnTracks apps you may be interested in; we reccomend you <a href="../json/">study the API documentation</a>.</p>
<h3 id="testing-your-http-endpoint">Testing your HTTP endpoint</h3>
<p>An simple example for testing a HTTP endpoint you set up:</p>
<pre><code class="language-bash">#!/bin/sh

user=jane
device=phone

payload=$(jo _type=location \
   t=u \
   batt=11 \
   lat=48.856826 \
   lon=2.292713 \
   tid=JJ \
   tst=$(date +%s) \
   topic=&quot;owntracks/$user/$device&quot;)

curl --data &quot;${payload}&quot; http://127.0.0.1:8085/pub?u=${user}&amp;d=${device}
</code></pre>
<ul>
<li>see also: <a href="../../features/traccar/">Traccar</a></li>
</ul>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../mqtt/" class="btn btn-neutral float-right" title="MQTT">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../json/" class="btn btn-neutral" title="JSON"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/owntracks/booklet/" class="fa fa-github" style="color: #fcfcfc"> GitHub</a>
        </span>
    
    
      <span><a href="../json/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../mqtt/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script>var base_url = '../..';</script>
    <script src="../../js/theme_extra.js" defer></script>
    <script src="../../js/theme.js" defer></script>
      <script src="../../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
