<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="OwnTracks.org" /><link rel="canonical" href="http://owntracks.org/booklet/features/tlscert/" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>Tlscert - OwnTracks Booklet</title>

  <link rel="stylesheet" href="../../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../css/theme_extra.css" type="text/css" />
  <link href="../../extra.css" rel="stylesheet">
    
      <script>
        // Current page data
        var mkdocs_page_name = "Tlscert";
        var mkdocs_page_input_path = "features/tlscert.md";
        var mkdocs_page_url = "/booklet/features/tlscert/";
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]--> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> OwnTracks Booklet
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../..">Intro</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Guide</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../guide/whathow/">What it does</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../guide/quicksetup/">Quicksetup</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../guide/apps/">Apps</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Features</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../comparison/">Comparison</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../security/">Security</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../location/">Location</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">API</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../tech/json/">JSON</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../tech/http/">HTTP</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../tech/program/">Code</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Sundry</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../privacy/">Privacy</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../people/">People</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../faq/">Answers</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../press/">Press</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">OwnTracks Booklet</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">Tlscert</li>
    <li class="wy-breadcrumbs-aside">
          <a href="https://github.com/owntracks/booklet/edit/master/docs/features/tlscert.md" class="icon icon-github"> Edit on GitHub</a>
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h2 id="client-certificates">Client certificates<a class="headerlink" href="#client-certificates" title="Permanent link">#</a></h2>
<p>The OwnTracks iOS and Android clients can be configured to use TLS client
certificates to authenticate against their MQTT broker. This is the next best
thing to two-factor authentication, where the apps have a TLS key and a
certificate which has to be presented to the broker for successful
authentication.</p>
<h3 id="mosquitto">Mosquitto<a class="headerlink" href="#mosquitto" title="Permanent link">#</a></h3>
<p>When using the Mosquitto <a href="../../guide/broker/">broker</a> support for TLS
certificates can be enabled as follows:</p>
<pre><code>require_certificate true
use_identity_as_username true
</code></pre>
<h3 id="client-certs">Client certs<a class="headerlink" href="#client-certs" title="Permanent link">#</a></h3>
<p>To create a client certificate and key, you can use, say, <code>generate-CA.sh</code> from
our <a href="https://github.com/owntracks/tools/tree/master/TLS">tools repository</a>.</p>
<pre><code class="language-bash">./generate-CA.sh client jjolie
</code></pre>
<p>This produces at least two files which are required on the OwnTracks devices: a <code>.key</code> file and a <code>.crt</code> file.</p>
<h3 id="pkcs12">PKCS#12<a class="headerlink" href="#pkcs12" title="Permanent link">#</a></h3>
<p>In order to safely transport a user's key and certificate to the OwnTracks app,
we make use of the <a href="https://en.wikipedia.org/wiki/PKCS_12">PKCS#12</a> container
format. OpenSSL's <code>pkcs12</code> subcommand creates this container and protects it
with a passphrase you specify. This passphrase we will later require in the app.</p>
<pre><code class="language-bash">openssl pkcs12 \
  -legacy \
  -export \
  -in jjolie.crt \
  -inkey jjolie.key \
  -name &quot;Jane's certificate/key&quot; \
  -out jjolie.p12
</code></pre>
<p>(Should you be using an older version of the <code>openssl</code> binary, omit the <code>-legacy</code> option.)</p>
<p>You now send the PKCS#12 file as attachment to the device, e.g. by e-mail. Note that for iOS, the file must have a <code>.otrp</code> extension so that it can be opened in OwnTracks.
You also send the CA certificate to the device and install it there, as discussed in <a href="../tls/">TLS</a></p>
<h3 id="android">Android<a class="headerlink" href="#android" title="Permanent link">#</a></h3>
<ul>
<li>Save the certificate to your device in an easy accessible location </li>
<li>Import the certificate into the app (Preferences, Connection, Security, Client certificate, Select) by opening it with the file choser. </li>
<li>The file will be copied to the secure storage location of the app. If the import is successfull, the original file can be removed from the device. </li>
<li>Specify the certificate password (certificates without password are not supported). </li>
</ul>
<h3 id="ios">iOS<a class="headerlink" href="#ios" title="Permanent link">#</a></h3>
<p>We recommend you proceed as follows:</p>
<ol>
<li>Install the <a href="../tls/">TLS</a> CA certificate in your system keystore by sending it (e.g. via e-mail) to your device and installing it in the system profile. (Click on the certificate and follow iOS' instructions.)</li>
<li>Send the prepared PKCS#12 file (with an <code>.otrp</code> extension) to your device, and open it. It will be imported into OwnTracks</li>
<li>Launch OwnTracks, select Settings and TLS. Select the <code>otrp</code> file you just imported as Client Certificate Filename, and below that, enter its passphrase.</li>
<li>Leave <em>Use Custom Security Policy</em> disabled.</li>
<li>Verify the connection to your broker.</li>
</ol>
<p>If need be, you can adjust a great number of parameters regarding how TLS connections will be verified: there are a number of settings available to fine-tune TLS connections between the app and the broker. The button <em>Use Custom Security Policy</em> can be enabled to do so. This switch allows you to control your TLS settings more granularly. If not switched on, it uses the default iOS settings and uses the iOS keychain for certificate validation only.</p>
<ul>
<li>Mode<ul>
<li>None; do not use pinned certificates to validate servers</li>
<li>Public Key; validate host (broker) certificates against the public keys of the pinned certificate</li>
<li>Certificate; validate host certificates against pinned certificates</li>
</ul>
</li>
<li>
<p>Pinned Server Certificate; select the certificate to use for pinning. Adding pinned SSL certificates to your app helps prevent man-in-the-middle attacks and other vulnerabilities. Applications dealing with sensitive customer data or financial information are strongly encouraged to route all communication over an SSL/TLS connection with SSL pinning configured and enabled.</p>
</li>
<li>
<p>Validate Certificate Chain; if enabled, the entire TLS certificate chain is validated and not just the leaf (host) certificate if disabled.</p>
</li>
<li>Allow untrusted Certificates should be disabled if possible. If the app doesn't have the CA certificate in its keychain, you'll have to allow untrusted certificates.</li>
<li>Validate Domain Name; whether or not to validate the domain name in the certificate's <code>CN</code> field.</li>
</ul>
<p>Note: on iOS self-signed certificates <strong>require</strong> <em>Custom Security Policy</em> to be set. (There seems to be a problem we have not tracked down yet. Using Custom Security Policy once does mark a self signed certificate as valid until the app is restarted. This isn't reset even when Custom Security Policy is switched off afterwards.)</p>
<p>Client certificates are independent of the custom security policy settings.</p>
<p>If you wish to use certificate pinning, you must provide a DER-encoded file with an <code>.otre</code> extension to the device containing the pinned certificate.</p>
<pre><code class="language-bash">openssl x509 \
   -in ca.crt \
   -out ca.otre \
   -outform DER
</code></pre>
              
            </div>
          </div><footer>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/owntracks/booklet" class="fa fa-github" style="color: #fcfcfc"> GitHub</a>
        </span>
    
    
    
  </span>
</div>
    <script src="../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../..";</script>
    <script src="../../js/theme_extra.js"></script>
    <script src="../../js/theme.js"></script>
      <script src="../../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
